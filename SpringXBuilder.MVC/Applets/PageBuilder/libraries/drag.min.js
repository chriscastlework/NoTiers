if(!sp||!sp.core||!sp.core.events){console.log("[ERROR:Drag package requires sp and sp.core.events packages]")}sp.namespace("drag.DragManager","drag.Draggable","drag.Droppable","drag.DroppableContainer","drag.DragEvent","drag.Sortable");drag.DragManager=Class.extend({__constructor:function(){this.droppables=[];this.draggables=[];this.currentDropTarget},registerDraggable:function(a){},registerDroppable:function(b){for(var a=0;a<this.droppables.length;a++){if(this.droppables[a]==b){throw new Error("Attempted to register a droppable which is already registered")}}this.droppables.push(b);return},unregisterDroppable:function(b){for(var a=0;a<this.droppables.length;a++){if(this.droppables[a]==b){this.droppables.splice(a,1);return}}throw new Error("Attempted to unregister a droppable which is not registered");return},getCandidatesForEvent:function(d,a){var e=[];var c=$(d).children();if($(d).is(a.getDragTarget())){return[]}for(var b=0;b<c.length;b++){e=e.concat(this.getCandidatesForEvent(c[b],a))}var f=this.getDroppableForTarget(d);if(f){if(a.getGroupID()!=null&&f.getGroupID()!=a.getGroupID()){return e}if(f.checkBounds(a)){e.push(f)}}return e},getDroppableForTarget:function(b){for(var a=0;a<this.droppables.length;a++){if(this.droppables[a].getTarget()==b){return this.droppables[a]}}return false},onDrag:function(a,e,g){var c=$("body").children();var f=[];for(var b=0;b<c.length;b++){var d=this.getCandidatesForEvent(c[b],a);if(d&&d.length){f=f.concat(d)}}for(var b=0;b<f.length;b++){var h=f[b].willAcceptDrop(a,e,g);if(h){if(this.currentDragTarget&&this.currentDragTarget!=f[b]){this.currentDragTarget.onDragOut(a,e,g)}this.currentDragTarget=f[b];this.currentDragTarget.onDragOver(a,e,g);a.onDragAccepted(this.currentDragTarget,e,g);return}}if(this.currentDragTarget){this.currentDragTarget.onDragOut(a,e,g);delete this.currentDragTarget}},onDrop:function(a,e,g){var c=$("body").children();var f=[];for(var b=0;b<c.length;b++){var d=this.getCandidatesForEvent(c[b],a);if(d&&d.length){f=f.concat(d)}}var h;for(var b=0;b<f.length;b++){h=f[b].willAcceptDrop(a,e,g);if(h){f[b].onDrop(a,e,g);break}}if(h){a.onDropAccepted(f[b],e,g)}else{a.onDrop(e,g)}}});drag.DragManager.INSTANCE=new drag.DragManager();drag.DragManager.getInstance=function(){return drag.DragManager.INSTANCE};drag.Draggable=sp.core.events.EventDispatcher.extend({__constructor:function(b,a){this.__super();this.target=b;this.options=this.getDefaultOptions(a);this.guid=sp.guid();this.originalStyling;this.guid=sp.guid();this.dragTarget;this.init()},toString:function(){return"[Draggable "+this.guid+"]"},init:function(){drag.DragManager.getInstance().registerDraggable(this);this.listenForMouseDown()},getEventWithNamespace:function(a){return a+"."+this.guid},getDefaultOptions:function(b){var a={revert:true,clone:false,helper:null,groupID:null};if(b){for(var c in b){a[c]=b[c]}}return a},getGroupID:function(){return this.options.groupID},getPlaceholder:function(){var b=$(this.dragTarget).clone();var a=$(this.dragTarget).prop("style");a.removeProperty("position");return b},createDragTarget:function(){this.originalStyling=this.getOriginalStyleProperties();var a=(this.options.clone)?$(this.target).clone().fadeTo(0,0.5):$(this.target).detach();$(document.body).append(a);$(a).css("position","absolute");$(a).zIndex(1000);$(a).offset(this.originalStyling.offset);return a},cleanDragTarget:function(){$(this.dragTarget).css("position",this.originalStyling.position);$(this.dragTarget).zIndex(this.originalStyling.z);$(this.dragTarget).css("left","");$(this.dragTarget).css("top","")},getOriginalStyleProperties:function(){return{position:$(this.target).css("position"),offset:$(this.target).offset(),parent:$(this.target).parent(),previousSibling:$(this.target).prev(),z:$(this.target).zIndex()}},onMouseDown:function(b,c){b.stopImmediatePropagation();b.stopPropagation();$(this.target).off(this.getEventWithNamespace("mousedown"));this.dragTarget=this.createDragTarget();this.offset={left:$(this.dragTarget).offset().left-b.pageX,top:$(this.dragTarget).offset().top-b.pageY};var a=this;$(document).on(this.getEventWithNamespace("mousemove"),function(f,d){a.onMouseMove(f,d)});$(document).on(this.getEventWithNamespace("mouseup"),function(f,d){a.onMouseUp(f,d)});this.dispatchEvent(new drag.DragEvent(this,drag.DragEvent.START,this.dragTarget,null,this,b))},onMouseMove:function(a,b){a.stopImmediatePropagation();a.stopPropagation();$(this.dragTarget).offset({left:a.pageX+this.offset.left,top:a.pageY+this.offset.top});drag.DragManager.getInstance().onDrag(this,a,b);this.dispatchEvent(new drag.DragEvent(this,drag.DragEvent.DRAG,this.dragTarget,null,this,a))},onMouseUp:function(a,b){a.stopImmediatePropagation();a.stopPropagation();$(document).off(this.getEventWithNamespace("mousemove"));$(document).off(this.getEventWithNamespace("mouseup"));drag.DragManager.getInstance().onDrop(this,a,b);this.listenForMouseDown();this.dispatchEvent(new drag.DragEvent(this,drag.DragEvent.STOP,this.dragTarget,null,this,a))},listenForMouseDown:function(){var a=this;$(this.target).on(this.getEventWithNamespace("mousedown"),function(c,b){a.onMouseDown(c,b)})},getDragTarget:function(){return this.dragTarget},getTarget:function(){return this.target},getDragElementBounds:function(){var a=$(this.dragTarget).offset();return{top:a.top,left:a.left,right:a.left+$(this.dragTarget).width(),bottom:a.top+$(this.dragTarget).height()}},getOffset:function(){return $(this.dragTarget).offset()},onDropAccepted:function(c,a,b){},onDrop:function(a,b){this.revert()},onDragAccepted:function(a){},revert:function(){if($(this.dragTarget).is(this.target)){if(this.originalStyling.previousSibling.length){$(this.originalStyling.previousSibling).after($(this.target).detach())}else{$(this.originalStyling.parent).prepend($(this.target).detach())}$(this.target).css("position",this.originalStyling.position);$(this.target).zIndex(this.originalStyling.zIndex);if(this.originalStyling.position=="absolute"||this.originalStyling.position=="relative"){$(this.target).offset(this.originalStyling.offset)}}else{$(this.dragTarget).remove()}}});drag.Droppable=sp.core.events.EventDispatcher.extend({__constructor:function(b,a){this.__super();this.target=b;this.options=this.getDefaultOptions(a);this.guid=sp.guid();drag.DragManager.getInstance().registerDroppable(this)},toString:function(){return"[Droppable "+this.guid()+"]"},getDefaultOptions:function(b){var a={revert:true,clone:false,helper:null,groupID:null};if(b){for(var c in b){a[c]=b[c]}}return a},checkBounds:function(a,e){if($(a.target).is(this.target)){return}var b=a.getDragElementBounds();var c=this.getBounds();var d=false;if(e=="fit"){}else{if(e=="overlap"){}}d=(b.left>=c.left&&b.left<=c.right&&b.top>=c.top&&b.top<=c.bottom);return d},addElementAtIndex:function(a,b){if(a==0){$(this.target).prepend(b)}else{if(a<=this.numChildren()-1){this.getChildren().eq(a).before(b)}else{$(this.target).append(b)}}return b},getGroupID:function(){return this.options.groupID},getTarget:function(){return this.target},getTargetZ:function(){return $(this.target).zIndex()},getBounds:function(){var a=$(this.target).offset();return{top:a.top,left:a.left,right:a.left+$(this.target).width(),bottom:a.top+$(this.target).height()}},indexOfElement:function(c){var b=$(this.target).children(":not(.drag-placeholder)").get();for(var a=0;a<b.length;a++){if(b[a]===c){return a}}return -1},getIndexForDropEvent:function(b){var a=b.getOffset();var e,f;var d=this.getChildren().get().reverse();for(var c=0;c<d.length;c++){e=d[c];f=this.getBoundsForElement(e);if(a.left>=f.left&&a.top>=f.top&&a.top<=f.bottom){return this.indexOfElement(e)+1}}d=d.reverse();for(var c=0;c<d.length;c++){e=d[c];f=this.getBoundsForElement(e);if(a.left<=f.right&&a.top>=f.top&&a.top<=f.bottom){return Math.max(this.indexOfElement(e)-1,0)}}return 0},getChildren:function(){return $(this.target).children(":not(.drag-placeholder)")},numChildren:function(){return this.getChildren().length},getBoundsForElement:function(c){var a=$(c).width();var b=$(c).height();var d=$(c).offset();return{left:d.left,right:d.left+a,top:d.top,bottom:d.top+b}},willAcceptDrop:function(a,b,c){var b=new drag.DragEvent(this,drag.DragEvent.DROP,a.getDragTarget(),this.getIndexForDropEvent(a),a,b);return(this.options.willAcceptDrop)?this.options.willAcceptDrop(b):true},onDragOver:function(a,b,c){var b=new drag.DragEvent(this,drag.DragEvent.OVER,a.getDragTarget(),this.getIndexForDropEvent(a),a,b);this.dispatchEvent(b)},onDragOut:function(a,b,c){var b=new drag.DragEvent(this,drag.DragEvent.OUT,a.getDragTarget(),null,a,b);this.dispatchEvent(b)},onDrop:function(a,c,d){var b=this.getIndexForDropEvent(a);a.cleanDragTarget();var c=new drag.DragEvent(this,drag.DragEvent.DROP,a.getDragTarget(),b,a,c);this.dispatchEvent(c)}});drag.DroppableContainer=drag.Droppable.extend({__constructor:function(b,a){this.__super(b,a);this.currentNextChild;this.placeholder},toString:function(){return"[DroppableContainer "+this.guid+"]"},removePlaceholder:function(){if(this.placeholder){$(this.placeholder).remove();delete this.placeholder}},getPlaceholder:function(b){var a=(this.options.getPlaceholder&&this.options.getPlaceholder(b))||$("<div></div>");a.addClass("drag-placeholder");a.css("position:","absolute");a.css("float","left");return a},onDragOver:function(a,c,d){var b=this.getIndexForDropEvent(a);var c=new drag.DragEvent(this,drag.DragEvent.OVER,a.getDragTarget(),b,a,c);if(!this.placeholder){this.placeholder=this.getPlaceholder(c)}this.addElementAtIndex(b,this.placeholder);this.dispatchEvent(c)},onDragOut:function(a,b,c){this.removePlaceholder();this.__super(a,b,c)},onDrop:function(a,b,c){this.__super(a,b,c);this.removePlaceholder()}});drag.Sortable=drag.DroppableContainer.extend({__constructor:function(c,a){this.__super(c,a);this.options.groupID=this.options.groupID||sp.guid();var b=this;$(this.target).children().each(function(){var d=new drag.Draggable(this,{groupID:b.options.groupID})})},toString:function(){return"[Sortable id:"+this.guid+"]"},willAcceptDrop:function(a,b,c){return a.getGroupID()==this.getGroupID()},onDrop:function(a,d,e){var g={w:$(a.getDragTarget()).width(),h:$(a.getDragTarget()).height()};var b=this.getIndexForDropEvent(a);this.__super(a,d,e);this.removePlaceholder();var c=this.addElementAtIndex(b,$(a.getDragTarget()).detach());var f={w:$(c).width(),h:$(c).height()};$(c).hide().fadeIn()},getPlaceholder:function(b){var a=$(b.element).clone()||$("<div></div>");$(a).addClass("drag-placeholder");$(a).css("position","");$(a).fadeTo(0,0.5);return a},setGroupID:function(a){this.options.groupID=a}});drag.DragEvent=sp.core.events.Event.extend({__constructor:function(f,e,d,c,b,a){this.__super(f,e);this.element=d;this.draggable=b;this.index=c;this.originalEvent=a},toString:function(){return"[DragEvent, type:"+this.type+" element:"+this.element+" index:"+this.index+" draggable:"+this.draggable+" originalEvent:"+this.originalEvent}});drag.DragEvent.START="drag_start";drag.DragEvent.DRAG="drag";drag.DragEvent.STOP="drag_stop";drag.DragEvent.OVER="drag_over";drag.DragEvent.OUT="drag_out";drag.DragEvent.DROP="drag_drop";